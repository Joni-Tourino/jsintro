<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DataJConf - D3 Example</title>
    <!-- D3 Version 4 -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- Colorbrewer Library for colour scales -->
    <script src="https://d3js.org/colorbrewer.v1.js"></script>
    <!-- Minimal styling -->
    <style>
        html, body, #vis {
            margin: 0;
            height: 100%;
            font-family: sans-serif;
        }

        form {
            padding: 10px;
        }

    </style>
</head>
<body>
    <!-- Input values for data creation -->
    <form>
        <input type="button" onclick="update()" value="Update"/>
        Max Height:
        <input type="range" value="50" min="0" max="100" id="maximumHeight">
        Max Weight:
        <input type="range" value="50" min="0" max="100" id="maximumWeight">
        Max IQ:
        <input type="range" value="50" min="0" max="100" id="maximumIQ">
        Max Speed:
        <input type="range" value="50" min="0" max="100" id="maximumSpeed">
    </form>

    <!-- Visualisation will go here -->
    <div id="vis"></div>

    <!-- The code! -->
    <script>

        /*
         *  DECLARATION BLOCK STARTS
         */
        var view_width = 500;
        var view_height = 500;

        var margin = {top: 50, bottom: 100, left: 100, right: 150};

        var width = view_width - margin.left - margin.right;
        var height = view_height - margin.top - margin.bottom;

        var maxDataItems = 150;
        var maxArea = 800;

        var x_scale = d3.scaleLinear() //Use D3 built in scaling
            .range([0, width]) //set property of scale to go from 0 to the value of width

        var y_scale = d3.scaleLinear() //Use D3 built in scaling
            .range([0, height]) //set range property of scale to go from 0 to the value of width

        var colour_scale = d3.scale = d3.scaleQuantile() //different scale - categorical
          .range(colorbrewer.Reds[9]) //A 9 colour red scale generated by Colorbrewer

        var area_scale = d3.scaleLinear() //Another scale for area of each circle
          .range([0,maxArea]);

        var svg = d3.select('#vis') //Using D3 to select
            .append('svg')
                .attr('height', height + margin.top + margin.bottom)
                .attr('width', width + margin.left + margin.right)
            .append('g') // grouping element to bind things together
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        svg.append('g')
          .attr('class','y axis'); //Add a class to our g tag

        svg.append('g')
          .attr('class','x axis')
          .attr('transform', 'translate(0,'+height+')'); // shift the x axis to the bottom

        var y_axis = d3.axisLeft(y_scale); //use the domain on y_scale to set the axis
        var x_axis = d3.axisBottom(x_scale); //use the domain on y_scale to set the axis

        /*
         *  DECLARATION BLOCK ENDS
         */

        function update() {
            /*
                Update function reads the input values, creates random data, and updates the visualisation accordingly
            */
            var maxHeightValue = d3.select('#maximumHeight').node().value;
            var maxWeightValue = d3.select('#maximumWeight').node().value;
            var maxIQ = d3.select('#maximumIQ').node().value;
            var maxSpeed = d3.select('#maximumSpeed').node().value;

            var exampleData = createRandomData(maxDataItems, maxHeightValue, maxWeightValue, maxIQ, maxSpeed);

            x_scale.domain([0, maxHeightValue]); //Set domain property for variables created earlier
            y_scale.domain([maxWeightValue,0]); //Reverse because we end at the top (0)not begin
            colour_scale.domain([0,maxIQ]); //Set range of colour scale - divide into buckets
            area_scale.domain([0,maxSpeed]); //Set range of area scale

            var t = d3.transition()
              .duration(2000);

            var dots = svg.selectAll('.dot') //there are no dots but they are selected anyway
                .data(exampleData); //and attach data to each,

            dots.exit()
              .transition(t) //add animation - we've set properties of transitions above
              .attr('r',0) //change radius to 0 - because of transition there will be a shrinking to that
              .attr('cx',0) //Collapse them back to origin on exit (because of transition)
              .attr('cy',height) //And to bottom
              .remove(); //this will remove dots it doesn't need (more than data points)

            var new_dots = dots.enter() // this will create dots that are needed
                .append('circle') //create the dot
                .attr('class','dot') // add class attribute
                .attr('r',5) //change radius to 5
                .attr('cx',0) // Start at x = 0 - but transition below will move it to different position
                .attr('cy',height)
                .attr('fill', 'red')
                .attr('stroke','black')
                .attr('stroke-width', '0.5px')
                ;

            new_dots.merge(dots) //merge the old and new dots
            .transition(t) //add animation - we've set properties of transitions above
            .attr('cx', function(d){
              return x_scale(d.Height) + 'px' //This uses the x_scale object which in turn uses the scale of the area
            }) //These properties are applied to the whole array of items rather than needing a loop
            .attr('cy', function(d){
              return y_scale(d.Weight) + 'px'
                  })
            .attr('fill',function(d){
              return colour_scale(d.IQ); //Change colour based on IQ attribute
                })
            .attr('r', function(d){ //set radius
              var area = area_scale(d.Speed); //Set area property based on scale set earlier
              var radius = Math.sqrt(area/Math.PI); //scale using square root
              return radius
            })

            d3.select('.x.axis')
              .call(x_axis);

            d3.select('.y.axis')
              .call(y_axis);
        }

        // call the update on page load to intialise the visualisation
        update();


        function createRandomData(maxDataItems, maxHeightValue, maxWeightValue, maxIQValue, maxSpeedValue) {
            /*
             * function to create an array of random data objects of size X,
             * where 1 <= X <= maxDataItems
             * Each object has properties "Height", "Weight", "IQ", "Speed", with
             * values V, where 1 <= V <= maxValue
             */
            var numDataItems = Math.floor((Math.random() * maxDataItems) + 1);
            var d = [];
            for(var i = 0; i < numDataItems; i++) {
                var height = Math.floor((Math.random() * maxHeightValue) + 1);
                var weight = Math.floor((Math.random() * maxWeightValue) + 1);
                var iq = Math.floor((Math.random() * maxIQValue) + 1);
                var speed = Math.floor((Math.random() * maxSpeedValue) + 1)
                d.push({
                    "Height": height,
                    "Weight": weight,
                    "IQ": iq,
                    "Speed": speed
                });
            }
            return d;
        }
    </script>

</body>
</html>
